# 故障注入场景监控配置清单（全链路观测版）

本清单针对故障注入的核心观测需求，覆盖 “基础设施→中间件→应用→业务” 全链路，明确 **监控指标、采集工具、阈值标准、告警策略**，确保故障注入时可实时捕捉性能波动、资源瓶颈及业务影响，同时支撑故障后复盘分析。

## 一、监控配置前置准备

在配置具体指标前，需完成基础环境搭建，确保监控链路通畅：



1.  **工具选型**：推荐 “Prometheus（指标采集）+ Grafana（可视化）+ Alertmanager（告警）” 组合（开源且适配多场景），或商业工具如 Zabbix、Datadog；

2.  **权限配置**：监控工具需获取目标对象的访问权限（如 Redis 的`info`权限、MySQL 的`PROCESS`权限、应用的 JMX 权限）；

3.  **数据存储**：Prometheus 配置至少 7 天数据保留期（支撑故障前后对比分析），高并发场景需扩容 TSDB 存储；

4.  **时间同步**：所有被监控节点（服务器、容器）需通过 NTP 同步时间（误差≤1 秒，避免指标时间戳混乱）。

## 二、分层监控配置清单（核心指标）

### 1. 硬件资源监控（对应 “CPU 高负载” 等硬件故障场景）

**监控目标**：捕捉服务器 CPU、内存、磁盘、网卡的资源瓶颈，验证故障注入对硬件的影响。



| 监控层级    | 指标名称           | 采集工具           | 监控频率 | 正常范围        | 告警阈值（警告 / 紧急）       | 告警渠道      | 关联故障场景           |
| ------- | -------------- | -------------- | ---- | ----------- | ------------------- | --------- | ---------------- |
| 服务器 CPU | 单核利用率（%）       | node\_exporter | 10 秒 | ≤70%        | 85%/95%             | 企业微信 + 短信 | CPU 高负载注入、应用线程泄漏 |
| 服务器 CPU | 平均负载（1 分钟）     | node\_exporter | 10 秒 | ≤CPU 核心数    | 1.2× 核心数 / 1.5× 核心数 | 企业微信      | CPU 高负载注入        |
| 内存      | 已用内存占比（%）      | node\_exporter | 10 秒 | ≤75%        | 85%/90%             | 企业微信 + 短信 | 内存泄漏故障、应用内存溢出    |
| 内存      | 交换分区使用率（%）     | node\_exporter | 30 秒 | ≤10%        | 20%/30%             | 企业微信      | 内存不足故障           |
| 磁盘      | 分区使用率（%）       | node\_exporter | 1 分钟 | ≤80%        | 85%/90%             | 企业微信 + 短信 | 磁盘满故障注入          |
| 磁盘      | 读写 IOPS（次 / 秒） | node\_exporter | 10 秒 | 无固定值（需基线）   | 超过基线值 120% / 150%   | 企业微信      | 磁盘 IO 密集型故障      |
| 网卡      | 带宽使用率（%）       | node\_exporter | 10 秒 | ≤70%（网卡总带宽） | 85%/95%             | 企业微信      | 网络流量饱和故障         |

### 2. 网络监控（对应 “延迟 / 丢包” 等网络故障场景）

**监控目标**：实时捕捉网络链路的延迟、丢包、端口通断，验证网络故障对服务通信的影响。



| 监控层级 | 指标名称                 | 采集工具                     | 监控频率 | 正常范围       | 告警阈值（警告 / 紧急）         | 告警渠道      | 关联故障场景      |
| ---- | -------------------- | ------------------------ | ---- | ---------- | --------------------- | --------- | ----------- |
| 网络链路 | 端到端延迟（ms）            | blackbox\_exporter（ICMP） | 5 秒  | ≤50ms（同机房） | 100ms/300ms           | 企业微信 + 短信 | 网络延迟注入      |
| 网络链路 | 丢包率（%）               | blackbox\_exporter（ICMP） | 5 秒  | ≤0.1%      | 1%/5%                 | 企业微信 + 短信 | 网络丢包注入      |
| 端口通断 | 目标端口存活状态             | blackbox\_exporter（TCP）  | 3 秒  | 存活（1）      | 断开（0）持续 5 秒 / 持续 10 秒 | 企业微信 + 电话 | 端口阻塞故障、服务宕机 |
| 网络连接 | TCP 连接数（ESTABLISHED） | node\_exporter           | 10 秒 | 无固定值（需基线）  | 超过基线值 120% / 150%     | 企业微信      | 连接泄漏故障      |
| 网络连接 | TCP TIME\_WAIT 数     | node\_exporter           | 30 秒 | ≤1000      | 3000/5000             | 企业微信      | 连接回收异常      |

### 3. 中间件监控（对应 “Redis 宕机” 等中间件故障场景）

#### 3.1 Redis 监控



| 监控层级     | 指标名称             | 采集工具            | 监控频率 | 正常范围              | 告警阈值（警告 / 紧急）                 | 告警渠道      | 关联故障场景       |
| -------- | ---------------- | --------------- | ---- | ----------------- | ----------------------------- | --------- | ------------ |
| Redis 节点 | 节点存活状态           | redis\_exporter | 5 秒  | 存活（1）             | 断开（0）持续 3 秒 / 持续 5 秒          | 企业微信 + 电话 | Redis 宕机注入   |
| Redis 节点 | 内存使用率（%）         | redis\_exporter | 10 秒 | ≤75%（maxmemory）   | 85%/95%                       | 企业微信      | Redis 内存满故障  |
| Redis 命令 | 命令执行耗时（ms，如 GET） | redis\_exporter | 10 秒 | ≤5ms              | 10ms/20ms                     | 企业微信      | Redis 性能退化故障 |
| Redis 主从 | 主从同步延迟（秒）        | redis\_exporter | 10 秒 | ≤1 秒              | 3 秒 / 5 秒                     | 企业微信 + 短信 | 主从同步中断故障     |
| Redis 连接 | 客户端连接数           | redis\_exporter | 10 秒 | ≤maxclients 的 80% | 90%maxclients / 95%maxclients | 企业微信      | 连接池耗尽故障      |

#### 3.2 RabbitMQ 监控（可选，对应消息队列故障场景）



| 指标名称       | 采集工具               | 正常范围     | 告警阈值（警告 / 紧急）        |
| ---------- | ------------------ | -------- | -------------------- |
| 队列消息堆积数    | rabbitmq\_exporter | ≤1000    | 5000/10000           |
| 消费者在线数量    | rabbitmq\_exporter | ≥1（核心队列） | 0 持续 3 秒 / 0 持续 10 秒 |
| 消息投递失败率（%） | rabbitmq\_exporter | ≤0.1%    | 1%/5%                |

### 4. 数据库监控（对应 “连接池耗尽 / 主库宕机” 等数据库故障场景）

#### 4.1 MySQL 监控



| 监控层级  | 指标名称                    | 采集工具             | 监控频率 | 正常范围                    | 告警阈值（警告 / 紧急）                             | 告警渠道      | 关联故障场景        |
| ----- | ----------------------- | ---------------- | ---- | ----------------------- | ----------------------------------------- | --------- | ------------- |
| 实例状态  | MySQL 存活状态              | mysqld\_exporter | 5 秒  | 存活（1）                   | 断开（0）持续 3 秒 / 持续 5 秒                      | 企业微信 + 电话 | MySQL 主库宕机注入  |
| 连接池   | 活跃连接数                   | mysqld\_exporter | 10 秒 | ≤max\_connections 的 70% | 85%max\_connections / 95%max\_connections | 企业微信 + 短信 | 连接池耗尽注入       |
| 连接池   | 连接等待数（Threads\_waiting） | mysqld\_exporter | 10 秒 | ≤5                      | 10/20                                     | 企业微信      | 连接竞争故障        |
| 查询性能  | 慢查询数（5 秒以上）             | mysqld\_exporter | 1 分钟 | ≤10 次 / 分钟              | 30 次 / 分钟 / 50 次 / 分钟                     | 企业微信      | 索引失效、SQL 优化不足 |
| 主从同步  | 从库延迟（秒）                 | mysqld\_exporter | 10 秒 | ≤3 秒                    | 10 秒 / 30 秒                               | 企业微信 + 短信 | 主从延迟注入        |
| 磁盘 IO | 表空间使用率（%）               | mysqld\_exporter | 5 分钟 | ≤80%                    | 85%/90%                                   | 企业微信      | 磁盘满导致写入失败     |

### 5. 应用服务监控（对应 “连接池耗尽 / 服务宕机” 等应用故障场景）

**适配 Spring Boot / 微服务架构，重点监控 “资源占用 - 接口性能 - 容错能力”**：



| 监控层级   | 指标名称           | 采集工具                            | 监控频率 | 正常范围          | 告警阈值（警告 / 紧急）           | 告警渠道      | 关联故障场景        |
| ------ | -------------- | ------------------------------- | ---- | ------------- | ----------------------- | --------- | ------------- |
| 实例状态   | 应用进程存活状态       | jmx\_exporter/Prometheus Agent  | 5 秒  | 存活（1）         | 断开（0）持续 3 秒 / 持续 5 秒    | 企业微信 + 电话 | 应用宕机故障        |
| JVM 内存 | 老年代使用率（%）      | jmx\_exporter                   | 10 秒 | ≤75%          | 85%/95%                 | 企业微信 + 短信 | 内存泄漏、对象未回收    |
| JVM 线程 | 活跃线程数          | jmx\_exporter                   | 10 秒 | ≤线程池核心数的 80%  | 90% 核心数 / 100% 核心数（满负载） | 企业微信      | 线程池耗尽故障       |
| JVM 线程 | 死锁线程数          | jmx\_exporter                   | 30 秒 | 0             | 1/2                     | 企业微信 + 电话 | 线程死锁故障        |
| 接口性能   | 核心接口平均响应时间（ms） | micrometer（应用埋点）                | 10 秒 | ≤200ms（根据业务定） | 300ms/500ms             | 企业微信      | 网络延迟、数据库慢查询   |
| 接口性能   | 接口错误率（%）       | micrometer（应用埋点）                | 10 秒 | ≤0.1%         | 1%/5%                   | 企业微信 + 短信 | 服务熔断、依赖不可用    |
| 容错能力   | 熔断触发次数（次 / 分钟） | micrometer（结合 Sentinel/Hystrix） | 1 分钟 | ≤10 次         | 50 次 / 分钟 / 100 次 / 分钟  | 企业微信      | 依赖服务宕机、熔断生效验证 |
| 连接池    | 数据库连接池活跃数      | jmx\_exporter                   | 10 秒 | ≤池最大值的 70%    | 85% 池最大值 / 95% 池最大值     | 企业微信      | 连接池耗尽注入验证     |

### 6. 业务指标监控（故障注入的 “最终观测目标”）

**聚焦核心业务链路，验证故障对业务的实际影响，避免 “技术指标正常但业务不可用”**：



| 监控层级 | 指标名称       | 采集方式                  | 监控频率 | 正常范围      | 告警阈值（警告 / 紧急）       | 告警渠道           | 关联故障场景         |
| ---- | ---------- | --------------------- | ---- | --------- | ------------------- | -------------- | -------------- |
| 电商订单 | 订单创建成功率（%） | 业务埋点（HTTP 接口 / 消息）    | 10 秒 | ≥99.9%    | 99.5%/99%           | 企业微信 + 短信 + 电话 | 支付故障、库存不足验证    |
| 电商支付 | 支付成功率（%）   | 支付回调日志埋点              | 10 秒 | ≥99.95%   | 99.5%/99%           | 企业微信 + 电话      | 支付系统宕机、网络中断    |
| 商品服务 | 商品查询成功率（%） | 接口埋点                  | 10 秒 | ≥99.9%    | 99.5%/99%           | 企业微信           | Redis 缓存宕机降级验证 |
| 用户服务 | 用户登录成功率（%） | 登录接口埋点                | 10 秒 | ≥99.9%    | 99.5%/99%           | 企业微信           | 数据库故障、账号服务不可用  |
| 业务流量 | 核心接口 QPS   | Prometheus counter 指标 | 10 秒 | 无固定值（需基线） | 低于基线 50% / 低于基线 30% | 企业微信           | 流量熔断、网关故障      |

## 三、告警策略配置（避免 “告警风暴”）



1.  **告警分级**：

*   P0（紧急）：业务中断（如订单成功率＜99%）、核心组件宕机（MySQL 主库宕机）→ 电话 + 短信 + 企业微信，5 分钟内响应；

*   P1（警告）：性能退化（接口响应时间超 300ms）、资源逼近阈值（CPU 达 85%）→ 短信 + 企业微信，15 分钟内响应；

*   P2（提示）：非核心指标异常（如非核心 Redis 连接数超阈值）→ 企业微信，1 小时内响应。

1.  **告警抑制**：

*   当 “MySQL 主库宕机（P0）” 告警触发时，自动抑制 “从库延迟（P1）”“应用连接池耗尽（P1）” 等衍生告警，避免重复通知；

*   同一指标 5 分钟内仅触发 1 次告警（如 CPU 高负载告警，5 分钟内不再重复发送）。

1.  **告警升级**：

*   P0 告警 10 分钟未确认，自动升级至团队负责人；

*   P1 告警 30 分钟未处理，自动升级至技术经理。

## 四、监控面板设计（Grafana 示例）

推荐按 “故障场景” 划分面板，方便实时观测：



1.  **CPU 高负载监控面板**：

*   核心图表：CPU 单核利用率趋势图、平均负载趋势图、进程 CPU 占用 Top5；

*   关键指标卡：当前 CPU 利用率、告警状态（正常 / 警告 / 紧急）。

1.  **Redis 宕机验证面板**：

*   核心图表：Redis 节点存活状态、客户端连接数趋势、主从同步延迟；

*   业务关联卡：商品查询成功率（验证缓存降级效果）。

1.  **网络丢包监控面板**：

*   核心图表：端到端延迟趋势、丢包率趋势、各网卡带宽使用率；

*   业务关联卡：支付成功率（验证网络对支付的影响）。

## 五、配置验证与维护



1.  **配置验证**：

*   故障注入前 1 小时，执行 “指标连通性测试”（如手动触发 1 次 CPU 高负载，确认监控能捕捉到利用率上升）；

*   检查告警触发逻辑（如模拟 Redis 宕机，确认 P0 告警在 5 秒内发出）。

1.  **日常维护**：

*   每周更新 “正常范围基线”（如业务流量增长后，QPS 基线需上调）；

*   每月清理无效监控项（如已下线服务的指标需从 Prometheus 配置中删除）；

*   每季度演练 “监控故障应急”（如 Prometheus 宕机时，切换至备用监控实例）。

## 六、注意事项



1.  **监控轻量化**：采集频率≤10 秒时，需确保监控 agent（如 node\_exporter）的 CPU 占用≤5%，避免影响被监控系统；

2.  **阈值个性化**：不同环境（测试 / 预发 / 生产）的阈值需差异化（如生产环境 CPU 紧急阈值 95%，测试环境可放宽至 98%）；

3.  **日志联动**：监控告警需关联日志查询链接（如 ELK 日志平台），方便快速定位故障根因（如接口错误率上升时，可直接查看错误日志）。

> （注：文档部分内容可能由 AI 生成）