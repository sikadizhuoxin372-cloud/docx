# 性能测试场景：Grafana 实时监控看板设计与配置指南

性能测试实时监控看板是**基于 Grafana（可视化）+ Prometheus（指标采集）构建的全链路实时观测面板**，核心目标是将性能测试中的 “压测工具指标、资源消耗指标、中间件性能指标、应用接口指标、业务吞吐量指标” 实时可视化，支持测试人员秒级发现 QPS 骤降、响应时间飙升、资源瓶颈等异常，同时为性能瓶颈定位提供 “实时数据支撑”—— 区别于事后日志分析，看板能实现 “问题发生时立即感知、立即定位”。

## 一、实时监控看板核心设计原则（性能测试特需）

1. **指标对齐性**：看板指标需与前文 “性能测试预热日志” 的验证指标完全一致（如 Redis 缓存命中率、MySQL 慢查询数），确保 “预热验证的日志” 与 “实时监控的数据” 同源，避免数据偏差；
2. **实时性优先**：指标刷新频率≤5 秒（默认 3 秒），性能核心指标（如 QPS、响应时间）需 “秒级更新”，避免因刷新延迟错过瞬时性能峰值（如 1 秒内的 CPU 骤升）；
3. **重点突出**：核心业务指标（如订单创建成功率）、致命异常（如 P0 告警）用 “大数字卡片 + 红黄灯” 突出，非核心指标（如磁盘空闲空间）用小型趋势图展示，避免视觉干扰；
4. **链路关联性**：支持 “指标钻取”（如点击接口 QPS 图，可下钻查看该接口的请求状态分布），且全链路指标可通过 `trace_id`关联（如从业务失败数钻取到具体慢查询 SQL）；
5. **环境适配性**：支持切换 “测试 / 预发 / 生产” 环境（通过 Grafana 变量实现），且指标阈值随环境差异化（如生产 CPU 紧急阈值 95%，测试环境放宽至 98%）。

## 二、实时监控看板整体架构与布局

基于性能测试 “压测工具→基础设施→中间件→应用→业务” 的核心链路，看板采用 “**顶部全局告警 + 中间分层指标 + 底部链路追踪**” 的布局，共分为 6 大模块，具体布局如下：

| 布局区域         | 包含模块                  | 核心作用                                 | 视觉优先级（大小 / 颜色）                                            |
| ---------------- | ------------------------- | ---------------------------------------- | -------------------------------------------------------------------- |
| 顶部（10% 高度） | 全局告警栏 + 核心业务指标 | 第一时间展示致命告警、核心业务状态       | 告警用红色闪烁弹窗；业务指标用大数字卡片（绿色 = 正常，红色 = 异常） |
| 左上（25% 高度） | 基础设施监控模块          | 实时观测 CPU、内存、磁盘 IO、网络瓶颈    | 趋势图（折线图）为主，超过阈值部分标红                               |
| 右上（25% 高度） | 压测工具监控模块          | 实时验证压测工具的请求发送状态           | 数字卡片（QPS / 错误率）+ 环形图（请求状态分布）                     |
| 左中（25% 高度） | 中间件监控模块            | 实时捕捉 Redis、MySQL 的性能瓶颈         | 仪表盘（命中率 / 使用率）+ 计数器（慢查询数）                        |
| 右中（25% 高度） | 应用服务监控模块          | 实时定位应用接口、JVM、线程池的性能问题  | 折线图（接口 QPS / 响应时间）+ 数字卡片（GC 次数）                   |
| 底部（15% 高度） | 业务链路追踪模块          | 实时查看核心业务链路的请求轨迹与异常详情 | 表格（展示 `trace_id`、业务阶段、耗时、状态）                      |

## 三、分模块看板配置详解（基于 Grafana 10.x）

以下模块配置均以 “Prometheus 为数据源”，需提前在 Grafana 中添加 Prometheus 数据源（`Configuration → Data Sources → Add data source → Prometheus`，填写 Prometheus 地址）。

### 模块 1：全局告警栏 + 核心业务指标（顶部）

#### 1.1 全局告警栏（红色闪烁弹窗）

* **功能**：实时展示 P0/P1 级告警（如 CPU≥95%、订单成功率≤99%），点击告警可跳转到对应指标面板；
* **配置步骤**：

1. 添加 “Alert List” 面板，数据源选择 Prometheus；
2. 告警规则筛选：`alertname=~"CPUHighLoad|OrderSuccessRateLow|MySQLSlowQuerySpike"`（匹配提前在 Prometheus 定义的告警规则）；
3. 视觉设置：告警状态为 “firing” 时，背景色设为红色，文字色设为白色，开启 “闪烁效果”；

* **核心告警规则示例**（需在 Prometheus 的 `alertmanager.yml`中定义）：

```
groups:

- name: performance-alerts

 rules:

  - alert: CPUHighLoad

    expr: avg(rate(node_cpu_seconds_total{mode!="idle"}[5m])) by (instance) * 100 ≥ 95

    for: 10s

    labels:

      severity: P0

    annotations:

      summary: "服务器CPU使用率过高"

      description: "服务器{{labels.instance }}的CPU使用率已达{{value | humanizePercentage }}，持续10秒"

  - alert: OrderSuccessRateLow

    expr: sum(rate(order_create_success_total\[5s])) / sum(rate(order_create_total[5s])) * 100 ≤ 99

    for: 5s

    labels:

      severity: P0

    annotations:

      summary: "订单创建成功率过低"

      description: "订单创建成功率已降至{{ \$value | humanizePercentage }}，持续5秒"
```

#### 1.2 核心业务指标（大数字卡片）

* **功能**：用 3-4 个大数字卡片展示核心业务的实时状态，一眼判断业务是否正常；
* **核心指标与配置**：

| 指标名称            | 可视化类型 | Prometheus 指标表达式                                                                       | 正常阈值     | 颜色规则（正常 / 异常）    |
| ------------------- | ---------- | ------------------------------------------------------------------------------------------- | ------------ | -------------------------- |
| 订单创建成功率（%） | 数字卡片   | sum(rate(order\_create\_success\_total\[5s])) / sum(rate(order\_create\_total\[5s])) \* 100 | ≥99.9%      | 绿色 / 红色                |
| 商品查询 QPS        | 数字卡片   | sum(rate(goods\_query\_total\[5s]))                                                         | 无（看趋势） | 蓝色（稳定）/ 橙色（骤降） |
| 支付成功率（%）     | 数字卡片   | sum(rate(pay\_success\_total\[5s])) / sum(rate(pay\_total\[5s])) \* 100                     | ≥99.95%     | 绿色 / 红色                |
| 业务异常数（个）    | 数字卡片   | sum(rate(business\_errors\_total\[5s]))                                                     | ≤0          | 绿色（0）/ 红色（>0）      |

### 模块 2：基础设施监控模块（左上，折线图为主）

* **功能**：实时展示服务器 CPU、内存、磁盘 IO、网络的实时波动，定位硬件资源瓶颈；
* **核心指标与配置**：

| 面板名称            | 图表类型 | Prometheus 指标表达式                                                                                                                                                                    | 刷新频率 | 阈值线设置（警告 / 紧急）      | 备注（关联预热日志）                   |
| ------------------- | -------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- | ------------------------------ | -------------------------------------- |
| CPU 使用率趋势      | 折线图   | avg(rate(node\_cpu\_seconds\_total{mode!="idle"}\[5s])) by (instance) \* 100                                                                                                             | 3 秒     | 85%（黄线）/95%（红线）        | 与预热日志中 “CPU 性能日志” 指标一致 |
| 内存使用率趋势      | 折线图   | (1 - (node\_memory\_available\_bytes / node\_memory\_total\_bytes)) \* 100 by (instance)                                                                                                 | 3 秒     | 85%（黄线）/90%（红线）        | 与预热日志中 “内存性能日志” 指标一致 |
| 磁盘 IOPS 趋势      | 折线图   | sum(rate(node\_disk\_io\_ops\_total\[5s])) by (instance, device)                                                                                                                         | 5 秒     | 基线 120%（黄线）/150%（红线） | 基线为预热时的 IOPS 峰值               |
| 网络带宽使用率（%） | 折线图   | sum(rate(node\_network\_transmit\_bytes\_total\[5s]) + rate(node\_network\_receive\_bytes\_total\[5s])) by (instance, device) / (node\_network\_speed\_bytes{device!\~"lo"} \* 8) \* 100 | 5 秒     | 85%（黄线）/95%（红线）        | 与预热日志中 “网络性能日志” 指标一致 |

* **布局建议**：4 个面板按 “2×2” 网格排列，每个面板标题标注服务器 IP（如 “CPU 使用率 - 10.0.0.10”），支持按实例筛选（通过 Grafana 变量 `$instance`）。

### 模块 3：压测工具监控模块（右上）

* **功能**：实时验证 JMeter/LoadRunner 的压测请求状态，判断压测是否正常（如是否存在大量超时）；
* **核心指标与配置**：

| 面板名称              | 图表类型          | Prometheus 指标表达式                                                                                             | 核心作用                                        |
| --------------------- | ----------------- | ----------------------------------------------------------------------------------------------------------------- | ----------------------------------------------- |
| JMeter 实时 QPS       | 数字卡片 + 折线图 | sum(rate(jmeter\_requests\_total\[5s])) by (test\_plan)                                                           | 看压测请求发送速率是否符合预期（如目标 500QPS） |
| JMeter 响应时间分位数 | 折线图            | histogram\_quantile(0.95, sum(rate(jmeter\_request\_duration\_seconds\_bucket\[5s])) by (le, test\_plan)) \* 1000 | 实时查看 95% 响应时间，判断是否飙升             |
| JMeter 请求状态分布   | 环形图            | sum(jmeter\_requests\_total) by (status, test\_plan)                                                              | 看成功（200）、失败（500）、超时（-1）的占比    |
| LoadRunner VU 状态    | 数字卡片          | sum(lr\_virtual\_users\_total{status="running"}) by (script)                                                      | 验证虚拟用户是否按预期启动（如目标 50VU）       |

* **配置注意**：需在 JMeter 中安装 `jmeter-prometheus-plugin`（将 JMeter 指标导出到 Prometheus），LoadRunner 需通过 LR Controller 的 “指标导出 API” 对接 Prometheus。

### 模块 4：中间件监控模块（左中）

* **功能**：实时捕捉 Redis、MySQL 的性能瓶颈（如缓存命中率低、慢查询突增），关联预热日志中的中间件指标；
* **核心指标与配置**：

#### 4.1 Redis 监控（2 个面板）

| 面板名称              | 图表类型 | Prometheus 指标表达式                                                                                                                                 | 正常阈值                          | 可视化设置（关联预热）                                                           |
| --------------------- | -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------- | -------------------------------------------------------------------------------- |
| Redis 缓存命中率（%） | 仪表盘   | sum(rate(redis\_keyspace\_hits\_total\[5s])) / (sum(rate(redis\_keyspace\_hits\_total\[5s])) + sum(rate(redis\_keyspace\_misses\_total\[5s]))) \* 100 | ≥90%                             | 绿色（≥90%）、黄色（80%-90%）、红色（<80%），与预热日志 “缓存命中率日志” 一致 |
| Redis 命令耗时（ms）  | 折线图   | avg(rate(redis\_command\_duration\_seconds\_sum{command=\~"GET                                                                                        | SET"}\[5s])) by (command) \* 1000 | ≤5ms                                                                            |

#### 4.2 MySQL 监控（3 个面板）

| 面板名称         | 图表类型          | Prometheus 指标表达式                                                                                                    | 正常阈值               | 可视化设置（关联预热）                                                                         |
| ---------------- | ----------------- | ------------------------------------------------------------------------------------------------------------------------ | ---------------------- | ---------------------------------------------------------------------------------------------- |
| MySQL 实时 QPS   | 数字卡片 + 折线图 | sum(rate(mysql\_global\_status\_questions\[5s])) by (instance)                                                           | 无（看趋势）           | 与预热日志 “数据库 QPS 日志” 指标一致                                                        |
| MySQL 慢查询数   | 计数器            | sum(rate(mysql\_global\_status\_slow\_queries\[5s])) by (instance)                                                       | ≤10 次 / 分钟         | 超过阈值时背景标红，与预热日志 “慢查询性能日志” 一致                                         |
| MySQL 连接池状态 | 表格              | max(hikaricp\_connections\_active) by (pool\_name, instance)  max(hikaricp\_connections\_idle) by (pool\_name, instance) | 活跃连接≤85% 池最大值 | 表格列：实例、池名称、活跃连接数、空闲连接数、最大连接数，与预热日志 “数据库连接池日志” 一致 |

### 模块 5：应用服务监控模块（右中）

* **功能**：实时定位应用接口、JVM、线程池的性能问题（如接口超时、GC 频繁），与预热日志的应用层指标对齐；
* **核心指标与配置**：

| 面板名称                | 图表类型 | Prometheus 指标表达式                                                                                                        | 正常阈值                            | 关联预热日志指标                                 |
| ----------------------- | -------- | ---------------------------------------------------------------------------------------------------------------------------- | ----------------------------------- | ------------------------------------------------ |
| 接口实时 QPS            | 折线图   | sum(rate(http\_server\_requests\_seconds\_count\[5s])) by (uri, method)                                                      | 无（看趋势）                        | 与预热日志 “接口性能日志” 的 QPS 一致          |
| 接口 95% 响应时间（ms） | 折线图   | histogram\_quantile(0.95, sum(rate(http\_server\_requests\_seconds\_bucket\[5s])) by (uri, le)) \* 1000                      | ≤200ms                             | 与预热日志 “接口性能日志” 的 p95\_rt 一致      |
| JVM Full GC 次数        | 计数器   | sum(rate(jvm\_gc\_collection\_seconds\_count{gc=\~"G1 Old Gen                                                                | PS MarkSweep"}\[5m])) by (instance) | ≤1 次 / 5 分钟                                  |
| 应用线程池状态          | 仪表盘   | sum(jvm\_threads\_states\_threads{state="runnable"}) by (instance) / sum(jvm\_threads\_states\_threads) by (instance) \* 100 | ≤80%                               | 运行线程占比，与预热日志 “线程池性能日志” 一致 |

* **配置注意**：应用需集成 `micrometer-registry-prometheus`（Spring Boot 应用），将 JVM、接口指标导出到 Prometheus。

### 模块 6：业务链路追踪模块（底部）

* **功能**：实时查看核心业务链路的请求轨迹（如 “订单创建→库存扣减→支付”），支持按 `trace_id`钻取异常详情，关联预热日志的 “业务链路日志”；
* **配置步骤**：

1. 集成 SkyWalking/Jaeger（全链路追踪工具），并将 SkyWalking/Jaeger 作为 Grafana 数据源；
2. 添加 “Trace List” 面板，筛选核心业务链路（如 `service_name=order-service AND operation_name=/api/v1/order/create`）；
3. 表格列配置：`trace_id`（可点击钻取）、`start_time`（请求开始时间）、`duration_ms`（链路耗时）、`status`（成功 / 失败）、`tags`（业务标签如 order\_no）；

* **核心价值**：当看板中 “订单成功率下降” 时，可点击异常 `trace_id`，查看链路中哪个阶段耗时过长（如库存扣减耗时 500ms），直接定位业务瓶颈点。

## 四、看板交互与优化设计（提升实用性）

1. **时间范围切换**：

* 默认展示 “实时 5 分钟” 数据（适合观察瞬时波动），支持切换为 “实时 30 分钟”“1 小时”（适合看长期趋势）；
* 在看板顶部添加 “Time Range” 控件，勾选 “Refresh every” 设置为 3 秒（实时刷新）。

1. **指标钻取功能**：

* 接口 QPS 折线图：点击某一时刻的 QPS 点，可下钻查看该时刻的 “请求状态分布”“异常请求详情”；
* Redis 命令耗时图：点击 SET 命令的耗时线，可下钻查看 SET 命令的 “具体参数”“响应时间分布直方图”。

1. **环境与实例筛选**：

* 在看板顶部添加 “变量控件”：`$environment`（测试 / 预发 / 生产）、`$instance`（服务器实例）、`$service`（应用服务名）；
* 指标表达式中引入变量，如 `node_cpu_seconds_total{environment="$environment", instance=~"$instance"}`，支持快速切换监控对象。

1. **移动端适配**：

* 在 Grafana 的 “Dashboard Settings → Mobile” 中开启 “Mobile Layout”，确保手机端查看时：核心业务指标（如成功率）居中，趋势图自适应缩小，告警弹窗置顶。

## 五、看板配置验证与维护（关联预热日志）

1. **配置验证（基于预热日志）**：

* 执行轻量压测（如 100 并发 JMeter 压测），验证看板指标与预热日志的一致性：

  * 看板中 “Redis 缓存命中率” 应与预热日志中计算的命中率偏差≤1%；
  * 看板中 “MySQL QPS” 应与预热日志中 “数据库 QPS 日志” 的 QPS 偏差≤5%；
  * 看板中 “接口响应时间” 应与预热日志中 “接口性能日志” 的响应时间完全一致。

1. **日常维护**：

* 每周更新 “指标基线”：如业务流量增长后，更新 MySQL QPS 的 “正常趋势范围”；
* 每月检查 “告警规则有效性”：如 CPU 阈值是否需要随服务器配置升级调整；
* 每季度优化 “看板布局”：根据性能测试中发现的高频问题，调整面板优先级（如慢查询问题频繁，则放大 MySQL 慢查询面板）。

## 六、常见问题与解决方法（看板配置避坑）

| 常见问题                           | 原因分析                                                                               | 解决方法                                                                                                                                                                                                     |
| ---------------------------------- | -------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 看板指标无数据（显示 “No Data”） | 1. Prometheus 未采集到指标（如 JMeter 插件未启用）；2. 指标表达式错误；3. 数据源未连接 | 1. 检查 Prometheus Targets（`http://prometheus-ip:9090/targets`），确认目标在线；2. 在 Prometheus UI 中测试指标表达式（如 `sum(rate(jmeter_requests_total[5s]))`）；3. 重新配置 Grafana 数据源，测试连接 |
| 指标刷新延迟（＞5 秒）             | 1. Grafana 刷新频率设置过高（如 10 秒）；2. Prometheus 采样间隔过大（如 15 秒）        | 1. 在看板顶部设置 “Refresh every 3 秒”；2. 调整 Prometheus Job 的 `scrape_interval: 1s`（性能指标）                                                                                                      |
| 链路追踪无法钻取 `trace_id`      | 1. SkyWalking/Jaeger 与 Grafana 未正确集成；2.`trace_id`未在日志中传递               | 1. 参考 SkyWalking 官方文档，在 Grafana 中安装 “SkyWalking Data Source” 插件；2. 确保应用调用中间件时传递 `trace_id`（如 Redis 命令添加 `trace_id`备注）                                               |

## 总结

性能测试实时监控看板的核心是 “**让性能指标‘说话’** ”—— 通过将预热日志中验证过的核心指标（如 QPS、响应时间、缓存命中率）转化为 “实时可视化图表 + 告警”，实现 “性能问题秒级感知、链路级定位”。看板需与性能测试流程深度结合：预热阶段验证看板数据准确性，正式测试阶段用看板实时观测瓶颈，复盘阶段基于看板数据追溯根因，最终形成 “预热 - 测试 - 复盘” 的性能优化闭环。

> （注：文档部分内容可能由 AI 生成）
